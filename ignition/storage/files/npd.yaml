- filesystem: "root"
  path: "/etc/kubernetes/addons/npd.yaml"
  mode: 0644
  contents:
    inline: |
      apiVersion: extensions/v1beta1
      kind: DaemonSet
      metadata:
        name: npd-v0.4.1
        namespace: kube-system
        labels:
          k8s-app: node-problem-detector
          version: v0.4.1
          kubernetes.io/cluster-service: "true"
          addonmanager.kubernetes.io/mode: Reconcile
      spec:
        template:
          metadata:
            labels:
              k8s-app: node-problem-detector
              version: v0.4.1
              kubernetes.io/cluster-service: "true"
          spec:
            containers:
            - name: node-problem-detector
              image: gcr.io/google_containers/node-problem-detector:v0.4.1
              command:
              - "/bin/sh"
              - "-c"
              # Pass both config to support both journald and syslog.
              - "/node-problem-detector --logtostderr --system-log-monitors=/config/kernel-monitor.json,/config/kernel-monitor-filelog.json,/config/docker-monitor.json,/config/docker-monitor-filelog.json >>/var/log/node-problem-detector.log 2>&1"
              securityContext:
                privileged: true
              resources:
                limits:
                  cpu: "200m"
                  memory: "100Mi"
                requests:
                  cpu: "20m"
                  memory: "20Mi"
              env:
              - name: NODE_NAME
                valueFrom:
                  fieldRef:
                    fieldPath: spec.nodeName
              volumeMounts:
              - name: log
                mountPath: /var/log
              - name: localtime
                mountPath: /etc/localtime
                readOnly: true
            volumes:
            - name: log
              hostPath:
                path: /var/log/
            - name: localtime
              hostPath:
                path: /etc/localtime
            serviceAccountName: node-problem-detector
            tolerations:
            - operator: "Exists"
              effect: "NoExecute"
            - key: "CriticalAddonsOnly"
              operator: "Exists"
            - key: "node.alpha.kubernetes.io/ismaster"
              effect: "NoSchedule"
      ---
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: node-problem-detector
        namespace: kube-system
        labels:
          kubernetes.io/cluster-service: "true"
          addonmanager.kubernetes.io/mode: Reconcile
